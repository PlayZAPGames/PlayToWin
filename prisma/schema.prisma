datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LoginType {
  guest
  google
  apple
  telegram
}

// Store item types
enum ItemType {
  weapon
  inventory 
}

generator client {
  provider = "prisma-client-js" // Specifies that you want to generate Prisma Client code
}

model Users {
  id        Int       @id @default(autoincrement())
  socialId  String?   @unique // stores telegram/google/apple ID
  loginType LoginType // enum: guest/google/telegram/apple

  // Auth identity
  username   String? @default("")
  imageUrl   String? // For image
  imageIndex Int?    @default(0) // For avatar

  // App status
  lastActive   Int
  role         String  @default("user")
  status       Int     @default(0) // 0-active, 1-restricted, 2-blocked
  language     String  @default("en")
  botStart     Boolean @default(false)
  notification Boolean @default(true)
  isBlocked    Boolean @default(false) // For block user

  // Currency - Cash-based system
  cash      Float    @default(0)     // Withdrawable USD balance
  gems      Float    @default(0)     // Withdrawable USD balance
  bonusBalance     Float    @default(0)     // Non-withdrawable promotional balance
  totalDeposited   Float    @default(0)     // Lifetime deposits
  totalWithdrawn   Float    @default(0)     // Lifetime withdrawals
  
  // PayPal Integration
  paypalEmail      String?                  // User's PayPal email for payments
  kycVerified      Boolean  @default(false) // KYC verification status

  gamesPlayed      Int                 @default(0)
  gamesWon         Int                 @default(0)
  fcmToken         String?             @unique
  token            String?             @unique
  refreshToken     String?             @unique
  refreshTokenExpiry DateTime?
  referree         Json                @default("{}")
  
  // Relations
  Tranactions      UserTransactions[]
  PaymentRequests  PaymentRequest[]
  CashTransactions CashTransaction[]
  DailyrewardUser  DailyRewards?
  UserReferrer     UserReferral[]      @relation("UserReferrer")
  UserReferee      UserReferral?       @relation("UserReferee")
  DailyTasks       DailyUserTasks[]
  user_spin_wheels user_spin_wheels[]
  UserPurchase     UserPurchase[]
  UserSuperPower   UserSuperPower[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  RewardHistory UserGameRewardHistory[] @relation("UserToRewardHistory")
  activities    activities[]
  UserWalletHistory UserWalletHistory[]

  @@index([id], map: "index_Users_on_id")
}


model Rooms {
  id                Int              @id @default(autoincrement())
  name              String?
  maxPlayers        Int              @default(4)
  currentPlayers    Int              @default(0)    // snapshot of joined players (atomic increment)
  gameId            Int?
  tournamentBlockId Int?             // NEW: link to TournamentBlock template
  entryFee          Float?
  currencyType      String?
  released          Boolean?         @default(false)
  freeEntry         Boolean          @default(false)
  releaseResponse   String?
  startTime         DateTime?
  releaseTime       DateTime?
  UserTournament    UserTournament[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // index for fast lookup of open rooms per block
  @@index([tournamentBlockId, released, currentPlayers])
  tournamentBlock   TournamentBlock? @relation(fields: [tournamentBlockId], references: [id])

}

model UserTournament {
  id                   Int                    @id @default(autoincrement())
  userId               Int
  userName             String
  banned               Boolean                @default(false)
  score                Int                    @default(0)
  scoreAry             Int[]                  @default([])
  roomId               Int
  room                 Rooms                  @relation(fields: [roomId], references: [id])
  UserTournamentScores UserTournamentScores[]
  tournamentBlockId Int
  tournamentBlock   TournamentBlock @relation(fields: [tournamentBlockId], references: [id])
  scoreSubmitted    Boolean @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  @@unique([userId, roomId]) // ðŸš¨ Required for upsert
}

model UserTournamentScores {
  id               Int            @id @default(autoincrement())
  userTournamentId Int
  userId           Int
  score            Int            @default(0)
  scoreAry         Int[]          @default([])
  rank             String?
  points           Int?
  time             Int?
  lives            Int            @default(3)
  timer            Float          @default(180)
  stats            Json           @default("{}")
  scoreSubmit      Boolean        @default(false)
  timerStarted     Boolean        @default(false)
  UserTournament   UserTournament @relation(fields: [userTournamentId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

// DEPRECATED: Crypto wallet model - replaced with PayPal payments
// model Wallets {
//   id            Int     @id @default(autoincrement())
//   pzpEvmWallet  String? @unique
//   evmWalletPapi String? @unique
//   tonWallet     String? @unique
//   isTonActive   Boolean @default(false)
//   User          Users   @relation(fields: [id], references: [id])
// }

model DailyUserTasks {
  id        Int      @id @default(autoincrement())
  user_id   Int      @unique
  user_name String?
  tasks     Json
  User      Users    @relation(fields: [user_id], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DailyTasksValues {
  id            Int       @id @default(autoincrement())
  task_name     String
  task_desc     String?
  task_pfp      String?
  task_redirect String?
  lastClaimDate DateTime?
  due_date      DateTime?
  reward        Float?
  reward_range  String?
  currency_type String?
  status        String    @default("InActive")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model UserReferral {
  id             Int      @id @default(autoincrement())
  referee        Int      @unique
  refereeAmount  Float    @default(0)
  redeem         Boolean  @default(false)
  referrer       Int
  referrerAmount Float    @default(0)
  referrerUser   Users    @relation("UserReferrer", fields: [referrer], references: [id])
  refereeUser    Users    @relation("UserReferee", fields: [referee], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model UserTransactions {
  id               Int      @id @default(autoincrement())
  user_id          Int
  amount           Float
  currency         String
  operation        String
  transaction_hash String?  @unique
  transaction_type String   @default("")
  status           String?
  User             Users    @relation(fields: [user_id], references: [id])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model UserWalletHistory {
  id               Int          @id @default(autoincrement())
  user_id          Int
  item_id          Int?
  from_amount      Float
  from_currency    String
  operation        String
  transaction_hash String?
  transaction_type String       @default("")
  status           String?
  to_amount        Float?
  to_currency      String?
  to_address       String?
  currency         String?
  amount           Float?
  User             Users        @relation(fields: [user_id], references: [id])
  activities       activities[] @relation("UserWalletHistoryToActivities") // Named relation for clarity
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model TournamentBlock {
  id            Int      @id @default(autoincrement())
  name          String
  gameId        Int
  game          games    @relation(fields: [gameId], references: [id])
  entryFee      Float
  currencyType  String   // 'gems', 'cash', or 'ads'
  prizePool     Float
  players    Int
  status        String   // 'active', 'completed', 'coming_soon'
  adsEnabled    Boolean  @default(false)
  resultAnnounced Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  UserTournaments UserTournament[]
  Rooms            Rooms[]
}

model Master {
  key   String  @unique
  data1 Json?
  data2 String? @db.VarChar(100)
}

model Notifications {
  id    String             @unique
  data1 NotificationsData?
}

model NotificationsData {
  id            String        @unique
  data          Json          @default("{}")
  Notifications Notifications @relation(fields: [id], references: [id])
}

model DailyRewards {
  id           Int      @id @default(autoincrement())
  user_id      Int      @unique
  dailySession Json?
  User         Users    @relation(fields: [user_id], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model admin_login_logs {
  id           BigInt    @id @default(autoincrement())
  admin_id     BigInt?
  ip_address   String?   @db.VarChar
  login_time   DateTime? @db.Timestamp(6)
  created_at   DateTime  @db.Timestamp(6)
  updated_at   DateTime  @db.Timestamp(6)
  ip_address_2 String?   @db.VarChar
  admin        Admins?   @relation(fields: [admin_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_rails_d4ea813624")

  @@index([admin_id], map: "index_admin_login_logs_on_admin_id")
}

model Admins {
  id                     BigInt             @id @default(autoincrement())
  email                  String             @unique(map: "index_admins_on_email") @default("") @db.VarChar
  encrypted_password     String             @default("") @db.VarChar
  name                   String?            @db.VarChar
  reset_password_token   String?            @unique(map: "index_admins_on_reset_password_token") @db.VarChar
  reset_password_sent_at DateTime?          @db.Timestamp(6)
  remember_created_at    DateTime?          @db.Timestamp(6)
  created_at             DateTime           @db.Timestamp(6)
  updated_at             DateTime           @db.Timestamp(6)
  player                 Int? //  enum player: ['super_admin', 'admin', 'manager', 'partner']
  modifiable_id          Int?
  modifiable_type        String?            @db.VarChar
  keypass                String?            @db.VarChar
  qr                     Boolean?           @default(false)
  admin_login_logs       admin_login_logs[]
  ProcessedPayments      PaymentRequest[]   @relation("ProcessedPayments")

  @@map("admins")
}

model UserGameRewardHistory {
  id        Int      @id @default(autoincrement())
  seasonId  Int?
  userId    Int
  gameId    Int
  roomId    Int?
  reward    Float
  rank      String?
  currency  String // e.g., "gems", "cash", "pzp_core"
  reason    String? // e.g., "win", "bonus", "referral"
  createdAt DateTime @default(now())
  User      Users    @relation(fields: [userId], references: [id], name: "UserToRewardHistory")
}

model games {
  id                  Int     @id @default(autoincrement())
  gameName            String
  imageIndex        Int?
  TournamentBlocks TournamentBlock[] // Add this line
}



model spin_wheels {
  id               Int                @id @default(autoincrement())
  name             String?            @db.VarChar
  is_disabled      Boolean?           @default(false)
  perc             Float?             @default(0.0)
  gems         Float?             @default(0.0)
  cash         Float?             @default(0.0)
  user_spin_wheels user_spin_wheels[]
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt
}

model user_spin_wheels {
  id            Int          @id @default(autoincrement())
  user_id       Int?
  spin_wheel_id Int?
  is_claimed    Boolean?     @default(false)
  created_at    DateTime     @db.Timestamp(6)
  updated_at    DateTime     @db.Timestamp(6)
  gems      Float?       @default(0.0)
  cash      Float?       @default(0.0)
  Users         Users?       @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_rails_41c571ff54")
  spin_wheels   spin_wheels? @relation(fields: [spin_wheel_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_rails_d03a19184d")

  @@index([spin_wheel_id], map: "index_user_spin_wheels_on_spin_wheel_id")
  @@index([user_id], map: "index_user_spin_wheels_on_user_id")
}

model activities {
  id                Int                @id @default(autoincrement())
  userId            Int?
  detail            Json?
  refId             Int?
  activity_type     String?
  wallet_history_id Int?
  userWalletHistory UserWalletHistory? @relation("UserWalletHistoryToActivities", fields: [wallet_history_id], references: [id])
  users             Users?             @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_rails_7e11bb717f")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId], map: "index_activities_on_user_id")
  @@index([wallet_history_id], map: "index_activities_on_wallet_history_id")
  @@index([createdAt], map: "index_activities_on_created_at")
  @@index([refId], map: "index_activities_on_ref_id")
  @@index([activity_type], map: "index_activities_on_activity_type")
}

model StoreItem {
  id           Int   @id @default(autoincrement())
  name         String
  type         ItemType
  price        Int? // cost to buy
  currencyType String // e.g. "gems" or "cash"
  description String?
  baseLevel   Int         @default(1)
  maxLevel    Int         @default(3)
  levels      ItemLevel[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  UserPurchase UserPurchase[]
}

// Master table for all store items
model ItemLevel {
  id          Int   @id @default(autoincrement())
  itemId      Int
  level       Int
  upgradeCost Int
  stats       Json
  StoreItem   StoreItem @relation(fields: [itemId], references: [id])

  @@unique([itemId, level])
}

// Which user bought what
model UserPurchase {
  id           Int    @id @default(autoincrement())
  userId       Int
  itemId       Int
  currentLevel Int       @default(1)
  unlocked     Boolean   @default(false)
  Users        Users     @relation(fields: [userId], references: [id])
  StoreItem    StoreItem @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId]) // optional: ensures 1 item per user
  @@index([userId])
  @@index([itemId])
}

model SuperPower {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  price       Int
  icon        String? // optional image/icon path
  isActive    Boolean @default(true)

  userPowers UserSuperPower[]
}

model UserSuperPower {
  id           Int      @id @default(autoincrement())
  userId       Int
  superPowerId Int
  quantity     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users      Users      @relation(fields: [userId], references: [id])
  superPower SuperPower @relation(fields: [superPowerId], references: [id])

  @@unique([userId, superPowerId]) // one row per user+power
}

// ==============================================================================
// NEW PAYMENT SYSTEM MODELS - PayPal Based Cash Gaming
// ==============================================================================

enum PaymentRequestType {
  deposit
  withdrawal
}

enum PaymentRequestStatus {
  pending
  approved
  rejected
  completed
  cancelled
}

// Payment requests for deposits and withdrawals
model PaymentRequest {
  id                  Int                   @id @default(autoincrement())
  userId              Int
  type                PaymentRequestType
  amount              Float
  paypalEmail         String
  paypalTransactionId String?               // Transaction ID after processing
  status              PaymentRequestStatus  @default(pending)
  adminNotes          String?               @db.Text
  proofImageUrl       String?               // For deposit receipts/proof
  rejectionReason     String?               @db.Text
  requestedAt         DateTime              @default(now())
  processedAt         DateTime?
  processedBy         BigInt?               // Admin ID who processed
  
  User            Users             @relation(fields: [userId], references: [id])
  ProcessedByAdmin Admins?          @relation("ProcessedPayments", fields: [processedBy], references: [id])
  CashTransactions CashTransaction[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([requestedAt])
}

enum CashTransactionType {
  deposit
  withdrawal
  game_entry
  game_win
  game_refund
  referral_bonus
  daily_bonus
  admin_credit
  admin_debit
  purchase
}

// Cash transaction history for all money movements
model CashTransaction {
  id               Int                 @id @default(autoincrement())
  userId           Int
  amount           Float               // Positive for credits, can be negative for tracking
  type             CashTransactionType
  balanceType      String              @default("cash") // 'cash' or 'bonus'
  balanceBefore    Float
  balanceAfter     Float
  description      String              @db.Text
  paymentRequestId Int?
  metadata         Json?               @default("{}")  // Additional data (game_id, room_id, etc)
  
  User           Users           @relation(fields: [userId], references: [id])
  PaymentRequest PaymentRequest? @relation(fields: [paymentRequestId], references: [id])
  
  createdAt      DateTime        @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}
